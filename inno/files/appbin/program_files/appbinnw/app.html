<!doctype html>
<html>
	<head>
		<title>Appbin - Sync Applications seamlessly</title>
			<script src="./includes/js/jquery.min.js"></script>
		<script type="text/javascript">
			var loginwindow;
			var gui = require('nw.gui');
			var mainwindow = gui.Window.get();
			var pathtoappbin = process.env.APPDATA + "\\appbin";
			var pathtodata = ""+gui.App.dataPath;
			var localpath = process.env.APPDATA;
			var flag=true;
			var firstTime;
			console.log(firstTime);
			var fs = require('fs');
			var iniReader = require('inireader');
			var parser = new iniReader.IniReader();
			var datapath = pathtoappbin + "\\data";
			fs.exists(datapath,function(exists){
				if(!exists){
					fs.mkdir(datapath);
					console.log("folder data created in appbin");
				} else {
					console.log("Data folder exists in appbin");
				}
			});
			var configpath = datapath + "\\config.ini";
			console.log(configpath);
			fs.exists(configpath,function(exists){
				if(!exists){
					console.log("config.ini does not exist and is created with default values");
					parser.param('main.name','');
					parser.param('main.path',pathtodata);
					parser.write(configpath);
				}
				else {
					parser.load(configpath);
					console.log("config.ini was already there and is now loaded");
				}
			});
			
			
			$(document).ready(function(){
					window.addEventListener("message", receiveMessage, false);
					var swig = require('swig');
					var spahql = require('spahql');
					// Only For Linux
				/*	var str = window.location.toString().match(/\/[^\/]+\/([^\.]+)/)[0]; 
					str = str.substring(0, str.lastIndexOf("/"));
					console.log("URL is: " + str.slice(0,str.lastIndexOf('/'))); 
					console.log(str);
					swig.init({ root:str}); */
					swig.init({root:'./'});
					var tmpl = swig.compileFile('views/allapps.html');
					var data = './includes/js/json/appdata.json';
					var responseText = require(data);					
					var db = spahql.db(responseText);
				//	console.log(""+gui.App.dataPath);
					
					if(localStorage.getItem("user.json") !== null){
						console.log("comes inside userjson block means LocalStorage is filled.");
						json = {"apps":responseText,"user":JSON.parse(localStorage.getItem("user.json")),"appbinpath":pathtoappbin};
						parser.param('main.name',localStorage.getItem('user_email'));
						var	userdatapath = datapath + "\\" + localStorage.getItem('user_email');
						//console.log(userdatapath);
							fs.exists(userdatapath,function(exists){
								if(!exists){
									fs.mkdir(userdatapath);
								//	console.log("Folder named yash created !");
								} else {
								//	console.log("Yash Folder was already there !");
								}
							});
							parser.param('main.path',userdatapath);
							parser.write(configpath);
							flag = false;
					} else {
						json = {"apps":responseText,"appbinpath":pathtoappbin};
					}
					$("#page").html(tmpl.render(json));
					$('#login').click(function(event){
						loginwindow = gui.Window.get(window.open("http://www.getappbin.com:3000/auth/google"));
					});
					
					var t = function(){
					   console.log("calling t.");
					   if(loginwindow !== undefined && flag) {
						if(typeof loginwindow.window.haveParent == 'function')
						{
							loginwindow.window.haveParent(mainwindow);
							console.log("calling haveParent");
						}
					  }
					  if (flag) setTimeout(t, 1000);
					};
					setTimeout(t, 1000);
					var userprofile;
					$("#logout").click(function(event){
						event.preventDefault();
						tmpl = swig.compileFile('views/allapps.html');
						localStorage.removeItem('user.json');
						localStorage.removeItem('user_name');
						localStorage.removeItem('user_email');
						
						parser.param('main.name','');
						parser.param('main.path','');
						parser.write(configpath);
						$("#page").html(tmpl.render({apps:responseText}));
						var gui1 = require('nw.gui');
						var currwin = gui.Window.get();
						currwin.reload();
					});
			});					
					
			function writeConfigFile(){
				console.log("comes inside userjson block means LocalStorage is filled.");
				parser.param('main.name',localStorage.getItem('user_email'));
				parser.write(configpath);
				var	userdatapath = datapath + "\\" + localStorage.getItem('user_email');
					fs.exists(userdatapath,function(exists){
						if(!exists){
							fs.mkdir(userdatapath);
						//	console.log("Folder named yash created !");
						} else {
						//	console.log("Yash Folder was already there !");
						}
					});
					parser.param('main.path',userdatapath);
					parser.write(configpath);	
					flag = false;
				
			} 	


            var GoToHelp = function(){

            location.href='views\\help.html';

            };	

		
			var openApp = function(args){
				cmd = pathtoappbin + "\\program_files\\appbin_nw.exe";
				console.log("path is "+ cmd);
				args = pathtoappbin + "\\program_files\\" + args;
				var app = args.split('/');
				//console.log(app[1]);
				if(localStorage.getItem("user.json") !== null){
					  var y = '--data-path='+pathtoappbin+'\\data\\'+localStorage.getItem('user_email')+'\\appsdata\\'+app[1];
			    }
			    else{
			          var y = '--data-path='+gui.App.dataPath+'\\appsdata\\'+app[1];
			    }
				 
				
				
				
				var spawn = require('child_process').spawn,
				ls    = spawn(cmd, [args, y ]);

				ls.stdout.on('data', function (data) {
				  console.log('stdout: ' + data);
				});

				ls.stderr.on('data', function (data) {
				  console.log('stderr: ' + data);
				});

				ls.on('close', function (code) {
				  console.log('child process exited with code ' + code);
				});									
			};
		
			function receiveMessage(event) {
				if(event.origin != "http://www.getappbin.com:3000"){
					alert("Bad login Request, Login Failed");
					return;
				}
				flag = false;
				localStorage.setItem("user.json",event.data);
				$("#page").html(tmpl.render({apps:responseText,user:JSON.parse(event.data),'appbinpath':pathtoappbin}));
				loginwindow.close();
				writeConfigFile();
				mainwindow.reload();
			}
			console.log(gui.App.dataPath[0]);
			console.log(pathtoappbin);
			
				 
					
		</script>
	</head>
		<div id="page"></div>
</html>
